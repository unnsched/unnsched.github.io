function russianDate(e){let t=e.split(".");return console.log(t),`${t[2]} ${({1:"января",2:"февраля",3:"марта",4:"апреля",5:"мая",6:"июня",7:"июля",8:"августа",9:"сентября",10:"октября",11:"ноября",12:"декабря"})[parseInt(t[1])]}`}function padTo2Digits(e){return e.toString().padStart(2,"0")}function formatDate(e){return[e.getFullYear(),padTo2Digits(e.getMonth()+1),padTo2Digits(e.getDate())].join(".")}let dateBegin=formatDate(new Date),dateEnd=formatDate(new Date(Date.now()+6048e5));function showCalendarPrompt(){showModal("date-picker"),document.getElementById("beginDate").valueAsNumber=Date.now(),document.getElementById("endDate").valueAsNumber=Date.now()+6048e5}function handleCalendarSelection(){dateBegin=formatDate(new Date(document.getElementById("beginDate").valueAsNumber)),dateEnd=formatDate(new Date(document.getElementById("endDate").valueAsNumber)),dismissModal(),reinitialize()}function dismissModal(){document.getElementById("modal").style.display="none"}function showModal(e){let t="modal-"+e;for(let n of document.getElementById("modal-content").children)n.style.display=n.id===t?"block":"none";document.getElementById("modal").style.display="block"}function cors(e){return"https://unn-sched-cors.herokuapp.com/"+e}const API_ENDPOINTS={groupSearch:cors("https://portal.unn.ru/ruzapi/search?term={label}&type=group"),schedule:cors("https://portal.unn.ru/ruzapi/schedule/group/{groupId}?start={start}&finish={end}&lng=1")},KIND_COLORS={262:"#B3E185",263:"#78D2FF",264:"#FFC26B"};function loadSchedule(e,t,n,i){fetch(API_ENDPOINTS.schedule.replace("{groupId}",e).replace("{start}",t).replace("{end}",n)).then(e=>e.json()).then(e=>i(e)).catch(e=>i("Ошибка при загрузке расписания: "+e))}function findGroups(e,t){fetch(API_ENDPOINTS.groupSearch.replace("{label}",e)).then(e=>e.json()).then(e=>t(e)).catch(e=>t("Ошибка при поиске группы: "+e))}function handleGroupSelection(e){localStorage.setItem("first_run",!1),localStorage.setItem("group_id",e.dataset.id),localStorage.setItem("group_label",e.dataset.label),dismissModal(),reinitialize(!0)}function showGroupPrompt(){showModal("group-picker");let e=document.getElementById("groupLabelInput");if(e.dataset.handled)return;let t=document.getElementById("groupSuggestions");e.addEventListener("input",e=>{e.target.value.length<7||findGroups(e.target.value,e=>{if(Array.isArray(e))for(let n of(t.innerHTML="",e))t.innerHTML+=`<div class="groupSuggestion selectable"data-id="${n.id}"data-label="${n.label}"onclick="handleGroupSelection(this)"><b>${n.label}</b><br>${n.description}</div>`;else alert("Ошибка при получении списка групп: "+e)})})}function reinitialize(e=!1){if(null==localStorage.getItem("first_run")){showGroupPrompt();return}let t=document.getElementById("schedule");t.innerHTML='<center style="margin: 8px 16px">Загрузка, пожалуйста, подождите...</center>';let n=e=>{document.getElementById("internal-group-id").innerText=e,loadSchedule(e,dateBegin,dateEnd,e=>{if(!Array.isArray(e)){alert("Ошибка при загрузке расписания: "+e);return}let n={};for(let i of e){i.date in n||(n[i.date]=[]);let a=n[i.date];a.push(i)}for(let l in t.innerHTML="",n){t.innerHTML+=`<div class="date-header">${russianDate(l)}</div>`;let r="";for(let s of n[l])r+=`<div class="schedule-entry"><div class="lesson-timing"><div class="lesson-block" style="background: ${KIND_COLORS[s.kindOfWorkOid]}">${s.lessonNumberStart}</div>${s.beginLesson}<br>${s.endLesson}</div><div class="lesson-details"><div class="lesson-title">${s.discipline}</div><div class="lesson-kind">${s.kindOfWork}</div><div class="lesson-auditorium"><span class="material-icons">location_on</span> ${s.auditorium} (${s.building})</div><div class="lesson-stream"><span class="material-icons">directions_walk</span> ${s.stream}</div><div class="lesson-lecturer"><span class="material-icons">person</span> ${s.lecturer.replace("!","")} (${s.lecturer_rank.toLowerCase().replace("!","")})</div></div></div>`;t.innerHTML+=`<div class="schedule-group">${r}</div>`}document.getElementById("header-title").innerText=localStorage.getItem("group_label")})};e?n(localStorage.getItem("group_id")):findGroups(localStorage.getItem("group_label"),e=>{if(0===e.length){alert("Группа не найдена");return}if(1!==e.length){alert("Поиск группы завершился неоднозначно");return}n(e[0].id)})}window.addEventListener("load",()=>{reinitialize(),document.addEventListener("click",e=>{"modal"===e.target.id&&null!=localStorage.getItem("first_run")?dismissModal():"lesson-details"===e.target.parentElement.className&&alert(e.target.innerText.includes(" ")?e.target.innerText.substring(e.target.innerText.indexOf(" ")+1):e.target.innerText)},!1)});
